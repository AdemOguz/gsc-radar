<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uye Kayitlari ve Islem Loglari</title>
  <meta name="robots" content="noindex,nofollow">
  <link rel="stylesheet" href="/static/header.css">
  <link rel="stylesheet" href="/static/dashboard-theme.css">
  <style>
    .admin-page {
      max-width: 1200px;
      margin: 0 auto;
    }
    .admin-hero {
      margin: 14px 0;
      border-radius: 16px;
      padding: 20px;
      color: #fff;
      background: linear-gradient(135deg, #0b3f6a 0%, #0f4c81 60%, #1d4ed8 100%);
    }
    .admin-toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .admin-toolbar input {
      min-width: 280px;
      background: #fff;
    }
    .user-list {
      display: grid;
      gap: 10px;
    }
    .user-item {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      overflow: hidden;
    }
    .user-head {
      display: grid;
      grid-template-columns: 1.2fr 1fr 1fr 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 12px;
      background: #f8fbff;
      border-bottom: 1px solid var(--line);
    }
    .user-head strong {
      color: #0f172a;
    }
    .user-meta {
      color: var(--muted);
      font-size: 13px;
    }
    .log-panel {
      padding: 10px 12px;
      display: none;
    }
    .log-panel.show {
      display: block;
    }
    .log-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .log-table th, .log-table td {
      border-bottom: 1px solid #e2e8f0;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }
    .log-table th {
      background: #f1f5f9;
      color: #334155;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .3px;
    }
    .badge-method {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      color: #fff;
      font-size: 11px;
      font-weight: 700;
    }
    .m-get { background: #2563eb; }
    .m-post { background: #16a34a; }
    .m-put, .m-patch { background: #f59e0b; }
    .m-delete { background: #dc2626; }
    .status-note {
      margin: 8px 0 0;
      color: #64748b;
      font-size: 13px;
    }
    .err {
      color: #b91c1c;
      font-weight: 600;
    }
    @media (max-width: 980px) {
      .user-head {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="appHeader"></div>
  <main class="admin-page">
    <section class="admin-hero">
      <h2 style="margin:0 0 8px;">Uye Kayitlari ve Islem Loglari</h2>
      <p style="margin:0; opacity:.92;">Kayitli uyeleri listele, her uye icin dropdown acarak gerceklestirdigi islemleri log satiri olarak gor.</p>
    </section>

    <section class="panel">
      <div class="admin-toolbar">
        <input id="searchUser" type="text" placeholder="E-posta veya ad ile ara...">
        <button type="button" onclick="loadUsers()">Yenile</button>
      </div>
      <p id="adminStatus" class="status-note">Yukleniyor...</p>
      <div id="userList" class="user-list"></div>
    </section>
  </main>

  <script>
    let allUsers = [];

    function esc(v) {
      return String(v || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function fmtDate(v) {
      if (!v) return "-";
      try { return new Date(v).toLocaleString("tr-TR"); } catch (_) { return v; }
    }

    function methodClass(method) {
      const m = String(method || "").toLowerCase();
      if (m === "get") return "m-get";
      if (m === "post") return "m-post";
      if (m === "put") return "m-put";
      if (m === "patch") return "m-patch";
      if (m === "delete") return "m-delete";
      return "m-get";
    }

    function renderUsers(list) {
      const root = document.getElementById("userList");
      if (!list.length) {
        root.innerHTML = "<p class='status-note'>Kullanici bulunamadi.</p>";
        return;
      }
      root.innerHTML = list.map(u => (
        "<article class='user-item'>" +
          "<div class='user-head'>" +
            "<div><strong>" + esc(u.name || "User") + "</strong><div class='user-meta'>" + esc(u.email || "-") + "</div></div>" +
            "<div class='user-meta'><strong>Kayit</strong><br>" + esc(fmtDate(u.created_at)) + "</div>" +
            "<div class='user-meta'><strong>Toplam Islem</strong><br>" + esc(u.activity_count || 0) + "</div>" +
            "<div class='user-meta'><strong>Son Islem</strong><br>" + esc(fmtDate(u.last_activity_at)) + "</div>" +
            "<div><button type='button' onclick=\"toggleLogs('" + esc(u.id) + "')\">Islemleri Goster</button></div>" +
          "</div>" +
          "<div id='log-" + esc(u.id) + "' class='log-panel'><p class='status-note'>Yukleniyor...</p></div>" +
        "</article>"
      )).join("");
    }

    function applySearch() {
      const q = (document.getElementById("searchUser").value || "").trim().toLowerCase();
      if (!q) return renderUsers(allUsers);
      const filtered = allUsers.filter(u =>
        String(u.email || "").toLowerCase().includes(q) ||
        String(u.name || "").toLowerCase().includes(q)
      );
      renderUsers(filtered);
    }

    function renderLogs(userId, logs) {
      const panel = document.getElementById("log-" + userId);
      if (!panel) return;
      if (!logs.length) {
        panel.innerHTML = "<p class='status-note'>Bu kullanici icin log kaydi bulunamadi.</p>";
        return;
      }
      panel.innerHTML =
        "<table class='log-table'><thead><tr>" +
        "<th>Tarih</th><th>Method</th><th>Path</th><th>Status</th><th>Query</th><th>IP</th>" +
        "</tr></thead><tbody>" +
        logs.map(l => (
          "<tr>" +
            "<td>" + esc(fmtDate(l.created_at)) + "</td>" +
            "<td><span class='badge-method " + methodClass(l.method) + "'>" + esc(l.method || "-") + "</span></td>" +
            "<td><code>" + esc(l.path || "-") + "</code></td>" +
            "<td>" + esc(l.status_code || "-") + "</td>" +
            "<td>" + esc(l.query_string || "-") + "</td>" +
            "<td>" + esc(l.ip_address || "-") + "</td>" +
          "</tr>"
        )).join("") +
        "</tbody></table>";
    }

    async function toggleLogs(userId) {
      const panel = document.getElementById("log-" + userId);
      if (!panel) return;
      const isOpen = panel.classList.contains("show");
      panel.classList.toggle("show", !isOpen);
      if (isOpen) return;
      if (panel.getAttribute("data-loaded") === "1") return;
      panel.innerHTML = "<p class='status-note'>Loglar yukleniyor...</p>";
      try {
        const res = await fetch("/admin/users/" + encodeURIComponent(userId) + "/activities?limit=120");
        const data = await res.json();
        if (!res.ok) throw new Error((data && data.detail) ? JSON.stringify(data.detail) : ("Istek basarisiz (HTTP " + res.status + ")"));
        renderLogs(userId, data.activities || []);
        panel.setAttribute("data-loaded", "1");
      } catch (e) {
        panel.innerHTML = "<p class='status-note err'>Loglar yuklenemedi: " + esc(e.message || e) + "</p>";
      }
    }

    async function loadUsers() {
      const status = document.getElementById("adminStatus");
      status.textContent = "Kullanicilar yukleniyor...";
      try {
        const res = await fetch("/admin/users?limit=500");
        const data = await res.json();
        if (!res.ok) throw new Error((data && data.detail) ? JSON.stringify(data.detail) : ("Istek basarisiz (HTTP " + res.status + ")"));
        allUsers = data.users || [];
        status.textContent = "Toplam " + (data.total_users || 0) + " uye listelendi.";
        renderUsers(allUsers);
      } catch (e) {
        status.innerHTML = "<span class='err'>Veri yuklenemedi: " + esc(e.message || e) + "</span>";
        document.getElementById("userList").innerHTML = "";
      }
    }

    document.getElementById("searchUser").addEventListener("input", applySearch);
    loadUsers();
  </script>
  <script src="/static/header.js"></script>
</body>
</html>
